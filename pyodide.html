<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Python in WebAssembly</title>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background-color: #1e1e1e;
      color: white;
      text-align: center;
      padding: 2rem;
    }

    #container {
      width: 80%;
      margin: auto;
    }

    textarea {
      width: 100%;
      height: 300px;
      background-color: #2b2b2b;
      color: #fff;
      caret-color: white;
      font-family: monospace;
      font-size: 16px;
      padding: 10px;
      border: 1px solid #444;
      border-radius: 6px;
      resize: vertical;
      white-space: pre;
      overflow: auto;
      outline: none;
    }

    pre {
      white-space: pre-wrap;
      background: #333;
      padding: 1rem;
      margin-top: 1rem;
      border-radius: 5px;
      text-align: left;
      color: #eee;
    }

    button {
      margin: 0.5rem;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }

    details {
      margin-top: 1rem;
      text-align: left;
    }

    summary {
      cursor: pointer;
      font-weight: bold;
      font-size: 16px;
    }

    ul {
      line-height: 1.6;
      margin-left: 20px;
    }
  </style>
</head>
<body>
  <div id="container">
    <h1>WebAssembly Python</h1>

    <textarea id="code" spellcheck="false">print("Hello, WebAssembly!")</textarea>
    <br>
    <button onclick="runCode()">‚ñ∂ Run (‚åò + B)</button>
    <button onclick="saveCodeCache()">üíæ Save Code to Cache</button>
    <button onclick="resetCodeCache()">üßπ Reset Code Cache</button>
    <pre id="output"></pre>

    <details>
      <summary>üîç Search LeetCode Problems</summary>
      <div style="margin-top: 1rem;">
        <input id="search-input" type="text" placeholder="Search by title or keyword..." style="padding: 10px; width: 60%; font-size: 16px; border-radius: 6px; border: 1px solid #666; background-color: #2b2b2b; color: white;">
        <button onclick="searchProblems()">Search</button>
        <ul id="search-results" style="margin-top: 1rem;"></ul>
      </div>
    </details>

    <div id="problem-display" style="text-align:left; background:#2b2b2b; padding:1rem; border-radius:6px; margin-bottom:1rem; margin-top:2rem;">
      <h2 id="problem-title">Random LeetCode Problem</h2>
      <p id="problem-description">Click a button below to load a random problem.</p>
    </div>

    <div style="margin-bottom: 1rem;">
      <button onclick="loadProblem('Easy')">üéØ Random Easy</button>
      <button onclick="loadProblem('Medium')">‚öñÔ∏è Random Medium</button>
      <button onclick="loadProblem('Hard')">üî• Random Hard</button>
    </div>
  </div>

  <script>
    let pyodideReady = false;
    let leetcodeData = [];

    async function main() {
      window.pyodide = await loadPyodide();
      
      await pyodide.loadPackage("pandas");
      
      pyodideReady = true;

      try {
        const response = await fetch("leetcode_dataset_clean.json");
        leetcodeData = await response.json();
      } catch (err) {
        console.error("‚ùå Failed to load leetcode_dataset_clean.json", err);
        document.getElementById("output").textContent = "‚ùå Failed to load problem dataset.";
      }

      // Load cached code on startup
      const saved = localStorage.getItem("userPythonCode");
      if (saved) {
        document.getElementById("code").value = saved;
      }
    }

    main();

    function saveCodeCache() {
      const code = document.getElementById("code").value;
      localStorage.setItem("userPythonCode", code);
      alert("‚úÖ Code saved to cache.");
    }

    function loadSavedCode() {
      const saved = localStorage.getItem("userPythonCode");
      if (saved) {
        document.getElementById("code").value = saved;
        alert("üìã Last saved code pasted.");
      } else {
        alert("‚ö†Ô∏è No saved code found.");
      }
    }

    function resetCodeCache() {
      const confirmReset = confirm("Clear your saved code from browser cache?");
      if (confirmReset) {
        localStorage.removeItem("userPythonCode");
        document.getElementById("code").value = "";
        alert("üßπ Code cache cleared.");
      }
    }

    async function runCode() {
      const output = document.getElementById("output");
      if (!pyodideReady) {
        output.textContent = "Loading Pyodide...";
        return;
      }

      try {
        await pyodide.runPythonAsync(`
import sys, io
sys.stdout = io.StringIO()
sys.stderr = sys.stdout
        `);
        const code = document.getElementById("code").value;
        await pyodide.runPythonAsync(code);
        const result = await pyodide.runPythonAsync("sys.stdout.getvalue()");
        output.textContent = result || "(No output)";
      } catch (err) {
        output.textContent = "‚ùå Error:\n" + err;
      }
    }

    async function loadProblem(difficulty) {
  const output = document.getElementById("output");
  if (!pyodideReady) {
    output.textContent = "Loading Pyodide...";
    return;
  }

  try {
    // Filter by difficulty and skip "None"/"none" descriptions
    const filtered = leetcodeData.filter(
      item =>
        item.difficulty.toLowerCase() === difficulty.toLowerCase() &&
        item.description &&
        item.description.toLowerCase() !== "none" &&
        item.description.toLowerCase() !== "sql schema"
    );

    if (filtered.length === 0) {
      output.textContent = `‚ùå No ${difficulty} problems found with valid descriptions.`;
      return;
    }

    const row = filtered[Math.floor(Math.random() * filtered.length)];
    const { id, title, description, url, difficulty: diffRaw } = row;
    const diff = diffRaw.toLowerCase();

    let color = "#fff";
    if (diff === "easy") color = "limegreen";
    else if (diff === "medium") color = "goldenrod";
    else if (diff === "hard") color = "tomato";

    function escapeHtml(text) {
      return text.replace(/[&<>"']/g, function (m) {
        return {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        }[m];
      });
    }

    let htmlDesc = escapeHtml(description)
      .replace(/`([^`]+)`/g, '<code>$1</code>')
      .replace(/\n\n/g, '<br><br>')
      .replace(/\n/g, '<br>');

    document.getElementById("problem-title").innerHTML =
      `<span style="color:${color}; font-weight:bold;">#${id} - ${title}</span> <a href="${url}" target="_blank" style="color:#66f">(View)</a>`;

    document.getElementById("problem-description").innerHTML = htmlDesc;

    // Save current problem metadata to cache
    const problemMeta = { id, title, url, description };
    localStorage.setItem("activeProblemMeta", JSON.stringify(problemMeta));

  } catch (err) {
    output.textContent = "‚ùå Error loading problem:\n" + err;
  }
}

    const textarea = document.getElementById("code");

    textarea.addEventListener("keydown", function (e) {
      const val = textarea.value;
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;

      if (e.key === "Tab") {
        e.preventDefault();
        textarea.value = val.substring(0, start) + "    " + val.substring(end);
        textarea.selectionStart = textarea.selectionEnd = start + 4;
      }

      else if (e.key === "Backspace" && start === end) {
        const before = val.substring(start - 4, start);
        if (before === "    ") {
          e.preventDefault();
          textarea.value = val.substring(0, start - 4) + val.substring(end);
          textarea.selectionStart = textarea.selectionEnd = start - 4;
        }
      }

      else if (e.key === "Enter" && e.shiftKey) {
        e.preventDefault();
        const currentLineEnd = val.indexOf("\n", start);
        const insertPos = currentLineEnd === -1 ? val.length : currentLineEnd;
        const currentLineStart = val.lastIndexOf("\n", start - 1) + 1;
        const indentMatch = val.slice(currentLineStart, start).match(/^\s*/);
        const indent = indentMatch ? indentMatch[0] : "";
        textarea.value = val.slice(0, insertPos) + "\n" + indent + val.slice(insertPos);
        textarea.selectionStart = textarea.selectionEnd = insertPos + 1 + indent.length;
      }

      else if (e.key === "Enter") {
        const lineStart = val.lastIndexOf("\n", start - 1) + 1;
        const currentLine = val.slice(lineStart, start);
        const indentMatch = currentLine.match(/^\s*/);
        const indent = indentMatch ? indentMatch[0] : "";
        const extraIndent = currentLine.trim().endsWith(":") ? "    " : "";
        e.preventDefault();
        const insert = "\n" + indent + extraIndent;
        textarea.value = val.substring(0, start) + insert + val.substring(end);
        textarea.selectionStart = textarea.selectionEnd = start + insert.length;
      }

      else if (e.key.toLowerCase() === "b" && e.metaKey) {
        e.preventDefault();
        runCode();
      }

      const pairs = {
        "(": ")",
        "[": "]",
        "{": "}",
        "'": "'",
        '"': '"'
      };

      if (pairs[e.key] && !e.ctrlKey && !e.metaKey) {
        e.preventDefault();
        const closingChar = pairs[e.key];
        textarea.value = val.substring(0, start) + e.key + closingChar + val.substring(end);
        textarea.selectionStart = textarea.selectionEnd = start + 1;
      }

      const nextChar = val.charAt(start);
      if (Object.values(pairs).includes(e.key) && nextChar === e.key) {
        e.preventDefault();
        textarea.selectionStart = textarea.selectionEnd = start + 1;
      }
    });

    function searchProblems() {
  const query = document.getElementById("search-input").value.toLowerCase().trim();
  const resultsList = document.getElementById("search-results");
  resultsList.innerHTML = "";

  if (!query || leetcodeData.length === 0) {
    resultsList.innerHTML = "<li>No search term entered or data not loaded.</li>";
    return;
  }

  const results = leetcodeData.filter(
    item =>
      item.title.toLowerCase().includes(query) ||
      (item.description && item.description.toLowerCase().includes(query))
  ).slice(0, 25); // Limit to 25 results

  if (results.length === 0) {
    resultsList.innerHTML = "<li>No matches found.</li>";
    return;
  }

  for (const result of results) {
    const li = document.createElement("li");
    li.innerHTML = `<strong style="color:lightgreen;">${result.title}</strong> - <a style="color: lightblue;" href="#" onclick="showProblemById(${result.id}); return false;">View</a>`;
    resultsList.appendChild(li);
  }
}

function showProblemById(id) {
  const item = leetcodeData.find(p => p.id === id);
  if (!item) {
    document.getElementById("output").textContent = "‚ùå Problem not found.";
    return;
  }

  const { title, description, url, difficulty } = item;
  const diff = difficulty.toLowerCase();

  let color = "#fff";
  if (diff === "easy") color = "limegreen";
  else if (diff === "medium") color = "goldenrod";
  else if (diff === "hard") color = "tomato";

  function escapeHtml(text) {
    return text.replace(/[&<>"']/g, function (m) {
      return {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      }[m];
    });
  }

  let htmlDesc = escapeHtml(description)
    .replace(/`([^`]+)`/g, '<code>$1</code>')
    .replace(/\n\n/g, '<br><br>')
    .replace(/\n/g, '<br>');

  document.getElementById("problem-title").innerHTML =
    `<span style="color:${color}; font-weight:bold;">#${id} - ${title}</span> <a href="${url}" target="_blank" style="color:#66f">(View)</a>`;
  document.getElementById("problem-description").innerHTML = htmlDesc;

  const problemMeta = { id, title, url, description };
  localStorage.setItem("activeProblemMeta", JSON.stringify(problemMeta));
}

  </script>
</body>
</html>