<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Python WebAssembly + LeetCode Editor</title>

  <!-- Pyodide -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>

  <!-- CodeMirror -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.css">
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/python/python.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/addon/edit/matchbrackets.js"></script>

  <style>
    body {
      margin: 0;
      background: #1e1e1e;
      color: white;
      font-family: sans-serif;
      height: 100vh;
      overflow: hidden;
    }

    #app {
      display: flex;
      height: 100vh;
    }

    /* LEFT: PROBLEM PANEL */
    #problem-panel {
      width: 35%;
      min-width: 320px;
      max-width: 45%;
      background: #252526;
      border-right: 1px solid #333;
      padding: 1rem;
      overflow-y: auto;
    }

    #problem-panel.hidden {
      display: none;
    }

    /* RIGHT: EDITOR PANEL */
    #editor-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 1rem;
      overflow: hidden;
    }

    .toolbar {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
      flex-wrap: wrap;
    }

    button {
      padding: 8px 14px;
      font-size: 14px;
      cursor: pointer;
      border-radius: 6px;
      border: none;
    }

    pre {
      background: #333;
      padding: 1rem;
      border-radius: 6px;
      overflow-y: auto;
      max-height: 160px;
    }

    #plot img {
      max-width: 100%;
      background: white;
      margin-top: 0.5rem;
      border-radius: 6px;
    }

    /* CodeMirror Styling */
    .CodeMirror {
      height: 100%;
      font-size: 15px;
      background: #1e1e1e;
      color: #fff;
      border-radius: 6px;
    }

    .CodeMirror-gutters {
      background: #1e1e1e;
      border-right: 1px solid #333;
    }

    #editor-wrapper {
      flex: 1;
      overflow: hidden;
      margin-bottom: 0.5rem;
    }

    #problem-title a {
      margin-left: 0.5rem;
    }
    
    /* ===== Improve CodeMirror cursor visibility ===== */
.CodeMirror-cursor {
  border-left: 2px solid #00ffff !important; /* bright cyan */
}

.CodeMirror-focused .CodeMirror-cursor {
  border-left: 2px solid #00ffff !important;
}

/* Optional: subtle line highlight where cursor is */
.CodeMirror-activeline-background {
  background: rgba(255, 255, 255, 0.04);
}
  </style>
</head>

<body>
<div id="app">

  <!-- ================= PROBLEM PANEL ================= -->
  <div id="problem-panel">
    <h2 id="problem-title">LeetCode Problem</h2>
    <div id="problem-description">
      Load a problem to begin.
    </div>

    <hr>

    <button onclick="loadProblem('Easy')">üéØ Easy</button>
    <button onclick="loadProblem('Medium')">‚öñÔ∏è Medium</button>
    <button onclick="loadProblem('Hard')">üî• Hard</button>

    <details style="margin-top:1rem;">
      <summary>üîç Search Problems</summary>
      <input id="search-input" placeholder="Search..." style="width:100%; margin-top:0.5rem;">
      <button onclick="searchProblems()">Search</button>
      <ul id="search-results"></ul>
    </details>
  </div>

  <!-- ================= EDITOR PANEL ================= -->
  <div id="editor-panel">

    <div class="toolbar">
      <button onclick="runCode()">‚ñ∂ Run (‚åò+B)</button>
      <button onclick="saveCodeCache()">üíæ Save</button>
      <button onclick="resetCodeCache()">üßπ Reset</button>
      <button onclick="toggleProblem()">üëÅ Toggle Problem</button>
    </div>

    <div id="editor-wrapper">
      <textarea id="code">
import matplotlib.pyplot as plt
import numpy as np

x = np.linspace(0, 10, 100)
y = np.sin(x)

plt.plot(x, y)
plt.show()
      </textarea>
    </div>

    <pre id="output">(Output)</pre>
    <div id="plot"></div>

  </div>
</div>

<script>
let editor;
let pyodideReady = false;
let leetcodeData = [];

editor = CodeMirror.fromTextArea(document.getElementById("code"), {
  mode: "python",
  theme: "default",
  lineNumbers: true,
  indentUnit: 4,
  tabSize: 4,
  indentWithTabs: false,
  matchBrackets: true,
  electricChars: true
});

editor.on("keydown", (cm, e) => {
  if (e.key === "Enter") {
    const line = cm.getLine(cm.getCursor().line);
    if (line.trim().endsWith(":")) {
      setTimeout(() => cm.replaceSelection("    "), 0);
    }
  }

  if (e.key.toLowerCase() === "b" && e.metaKey) {
    e.preventDefault();
    runCode();
  }
});

async function main() {
  window.pyodide = await loadPyodide();
  await pyodide.loadPackage(["matplotlib", "numpy", "pandas"]);
  pyodideReady = true;

  const saved = localStorage.getItem("userPythonCode");
  if (saved) editor.setValue(saved);

  try {
    const r = await fetch("leetcode_dataset_clean.json");
    leetcodeData = await r.json();
  } catch {
    document.getElementById("output").textContent = "‚ùå Failed to load problems.";
  }
}
main();

function toggleProblem() {
  document.getElementById("problem-panel").classList.toggle("hidden");
}

function saveCodeCache() {
  localStorage.setItem("userPythonCode", editor.getValue());
  alert("Saved!");
}

function resetCodeCache() {
  if (confirm("Clear saved code?")) {
    editor.setValue("");
    localStorage.removeItem("userPythonCode");
  }
}

async function runCode() {
  const output = document.getElementById("output");
  const plot = document.getElementById("plot");
  plot.innerHTML = "";

  if (!pyodideReady) {
    output.textContent = "Loading...";
    return;
  }

  try {
    await pyodide.runPythonAsync(`
import sys, io, matplotlib
matplotlib.use("AGG")
import matplotlib.pyplot as plt
sys.stdout = io.StringIO()
sys.stderr = sys.stdout
    `);

    await pyodide.runPythonAsync(editor.getValue());

    output.textContent =
      await pyodide.runPythonAsync("sys.stdout.getvalue()") || "(No output)";

    const imgs = await pyodide.runPythonAsync(`
import base64, io
imgs=[]
for i in plt.get_fignums():
    buf=io.BytesIO()
    plt.figure(i).savefig(buf, format="png")
    buf.seek(0)
    imgs.append("data:image/png;base64,"+base64.b64encode(buf.read()).decode())
    plt.close(i)
imgs
    `);

    imgs.forEach(src => {
      const img = document.createElement("img");
      img.src = src;
      plot.appendChild(img);
    });

  } catch (err) {
    output.textContent = err;
  }
}
</script>
</body>
</html>