<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Python in WebAssembly + Matplotlib + LeetCode</title>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background-color: #1e1e1e;
      color: white;
      text-align: center;
      padding: 2rem;
    }
    #container { width: 80%; margin: auto; }
    textarea {
      width: 100%;
      height: 300px;
      background-color: #2b2b2b;
      color: #fff;
      caret-color: white;
      font-family: monospace;
      font-size: 16px;
      padding: 10px;
      border: 1px solid #444;
      border-radius: 6px;
      resize: vertical;
      white-space: pre;
      overflow: auto;
      outline: none;
    }
    pre {
      white-space: pre-wrap;
      background: #333;
      padding: 1rem;
      margin-top: 1rem;
      border-radius: 5px;
      text-align: left;
      color: #eee;
    }
    #plot img {
      margin-top: 1rem;
      border: 1px solid #666;
      border-radius: 6px;
      max-width: 100%;
      background-color: white;
    }
    button {
      margin: 0.5rem;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }
    details { margin-top: 1rem; text-align: left; }
    summary { cursor: pointer; font-weight: bold; font-size: 16px; }
    ul { line-height: 1.6; margin-left: 20px; }
    #problem-display { text-align:left; background:#2b2b2b; padding:1rem; border-radius:6px; margin-bottom:1rem; margin-top:2rem; }
  </style>
</head>
<body>
  <div id="container">
    <h1>WebAssembly Python + Matplotlib + LeetCode</h1>

    <textarea id="code" spellcheck="false">
import matplotlib.pyplot as plt
import numpy as np

x = np.linspace(0, 10, 100)
y = np.sin(x)

plt.plot(x, y, color='limegreen', linewidth=2)
plt.title("Sine Wave Example")
plt.xlabel("X values")
plt.ylabel("sin(X)")
plt.grid(True)
    </textarea>
    <br>
    <button onclick="runCode()">‚ñ∂ Run (‚åò + B)</button>
    <button onclick="saveCodeCache()">üíæ Save Code</button>
    <button onclick="resetCodeCache()">üßπ Reset</button>

    <pre id="output">(Program output will appear here)</pre>
    <h3>Plots:</h3>
    <div id="plot"></div>

    <details>
      <summary>üîç Search LeetCode Problems</summary>
      <div style="margin-top: 1rem;">
        <input id="search-input" type="text" placeholder="Search by title or keyword..." style="padding: 10px; width: 60%; font-size: 16px; border-radius: 6px; border: 1px solid #666; background-color: #2b2b2b; color: white;">
        <button onclick="searchProblems()">Search</button>
        <ul id="search-results" style="margin-top: 1rem;"></ul>
      </div>
    </details>

    <div id="problem-display">
      <h2 id="problem-title">Random LeetCode Problem</h2>
      <p id="problem-description">Click a button below to load a random problem.</p>
    </div>

    <div>
      <button onclick="loadProblem('Easy')">üéØ Random Easy</button>
      <button onclick="loadProblem('Medium')">‚öñÔ∏è Random Medium</button>
      <button onclick="loadProblem('Hard')">üî• Random Hard</button>
    </div>
  </div>

<script>
let pyodideReady = false;
let leetcodeData = [];

async function main() {
  window.pyodide = await loadPyodide();
  await pyodide.loadPackage(["matplotlib", "numpy", "pandas"]);
  pyodideReady = true;

  try {
    const response = await fetch("leetcode_dataset_clean.json");
    leetcodeData = await response.json();
  } catch (err) {
    console.error("‚ùå Failed to load dataset", err);
    document.getElementById("output").textContent = "‚ùå Failed to load problem dataset.";
  }

  const saved = localStorage.getItem("userPythonCode");
  if (saved) document.getElementById("code").value = saved;
}

main();

function saveCodeCache() {
  const code = document.getElementById("code").value;
  localStorage.setItem("userPythonCode", code);
  alert("‚úÖ Code saved to cache.");
}

function resetCodeCache() {
  if (confirm("Clear saved code?")) {
    localStorage.removeItem("userPythonCode");
    document.getElementById("code").value = "";
    alert("üßπ Cache cleared.");
  }
}

async function runCode() {
  const output = document.getElementById("output");
  const plotDiv = document.getElementById("plot");
  plotDiv.innerHTML = "";
  if (!pyodideReady) { output.textContent = "Loading Pyodide..."; return; }

  const code = document.getElementById("code").value;

  try {
    await pyodide.runPythonAsync(`
import sys, io, base64, matplotlib
matplotlib.use("AGG")
import matplotlib.pyplot as plt
sys.stdout = io.StringIO()
sys.stderr = sys.stdout
    `);

    await pyodide.runPythonAsync(code);

    const textOutput = await pyodide.runPythonAsync("sys.stdout.getvalue()");
    output.textContent = textOutput || "(No output)";

    const imgs = await pyodide.runPythonAsync(`
import matplotlib.pyplot as plt, io, base64
imgs = []
for i in plt.get_fignums():
    buf = io.BytesIO()
    plt.figure(i).savefig(buf, format='png', bbox_inches='tight')
    plt.close(i)
    buf.seek(0)
    imgs.append("data:image/png;base64," + base64.b64encode(buf.read()).decode())
imgs
    `);

    for (const src of imgs) {
      const img = document.createElement("img");
      img.src = src;
      plotDiv.appendChild(img);
    }

  } catch(err) {
    output.textContent = "‚ùå Error:\n" + err;
  }
}

// Run with ‚åò+B
document.getElementById("code").addEventListener("keydown", (e) => {
  if (e.key.toLowerCase() === "b" && e.metaKey) {
    e.preventDefault();
    runCode();
  }
});

// --- LeetCode Problem Functions ---
function searchProblems() {
  const query = document.getElementById("search-input").value.toLowerCase().trim();
  const resultsList = document.getElementById("search-results");
  resultsList.innerHTML = "";
  if (!query || leetcodeData.length === 0) {
    resultsList.innerHTML = "<li>No search term entered or data not loaded.</li>";
    return;
  }
  const results = leetcodeData.filter(
    item =>
      item.title.toLowerCase().includes(query) ||
      (item.description && item.description.toLowerCase().includes(query))
  ).slice(0, 25);

  if (results.length === 0) {
    resultsList.innerHTML = "<li>No matches found.</li>";
    return;
  }

  for (const result of results) {
    const li = document.createElement("li");
    li.innerHTML = `<strong style="color:lightgreen;">${result.title}</strong> - <a style="color: lightblue;" href="#" onclick="showProblemById(${result.id}); return false;">View</a>`;
    resultsList.appendChild(li);
  }
}

async function loadProblem(difficulty) {
  const output = document.getElementById("output");
  if (!pyodideReady) { output.textContent = "Loading Pyodide..."; return; }

  try {
    const filtered = leetcodeData.filter(
      item =>
        item.difficulty.toLowerCase() === difficulty.toLowerCase() &&
        item.description &&
        item.description.toLowerCase() !== "none" &&
        item.description.toLowerCase() !== "sql schema"
    );
    if (filtered.length === 0) {
      output.textContent = `‚ùå No ${difficulty} problems found with valid descriptions.`;
      return;
    }
    const row = filtered[Math.floor(Math.random() * filtered.length)];
    showProblemById(row.id);
  } catch (err) {
    output.textContent = "‚ùå Error loading problem:\n" + err;
  }
}

function showProblemById(id) {
  const item = leetcodeData.find(p => p.id === id);
  if (!item) {
    document.getElementById("output").textContent = "‚ùå Problem not found.";
    return;
  }

  const { title, description, url, difficulty } = item;
  const diff = difficulty.toLowerCase();
  let color = "#fff";
  if (diff === "easy") color = "limegreen";
  else if (diff === "medium") color = "goldenrod";
  else if (diff === "hard") color = "tomato";

  function escapeHtml(text) {
    return text.replace(/[&<>"']/g, function (m) {
      return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m];
    });
  }

  let htmlDesc = escapeHtml(description)
    .replace(/`([^`]+)`/g, '<code>$1</code>')
    .replace(/\n\n/g, '<br><br>')
    .replace(/\n/g, '<br>');

  document.getElementById("problem-title").innerHTML =
    `<span style="color:${color}; font-weight:bold;">#${id} - ${title}</span> <a href="${url}" target="_blank" style="color:#66f">(View)</a>`;
  document.getElementById("problem-description").innerHTML = htmlDesc;

  const problemMeta = { id, title, url, description };
  localStorage.setItem("activeProblemMeta", JSON.stringify(problemMeta));
}
</script>
</body>
</html>
